<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contact Finder - AI-Powered Lead Generation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
        .loading-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .contact-card {
            background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
            border: 1px solid #e2e8f0;
        }
        .source-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        .hunter-badge {
            background-color: #fef3c7;
            color: #92400e;
        }
        .apollo-badge {
            background-color: #dbeafe;
            color: #1e40af;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="gradient-bg text-white shadow-lg">
        <div class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <i data-lucide="target" class="w-8 h-8"></i>
                    <h1 class="text-2xl font-bold">Contact Finder</h1>
                </div>
                <div class="text-sm opacity-90">
                    AI-Powered Lead Generation
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-8">
        <!-- Search Section -->
        <div class="bg-white rounded-xl shadow-lg p-8 mb-8 card-hover">
            <div class="text-center mb-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-3">Find Quality Contacts</h2>
                <p class="text-gray-600 text-lg">Enter a company domain to discover verified email addresses and contact information</p>
            </div>

            <!-- Search Form -->
            <div class="max-w-2xl mx-auto">
                <div class="flex gap-4 mb-6">
                    <div class="flex-1">
                        <input type="text" 
                               id="domain-input" 
                               placeholder="Enter company domain (e.g., salesforce.com)" 
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent text-lg">
                    </div>
                    <button onclick="searchCompany()" 
                            class="px-8 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold text-lg flex items-center gap-2">
                        <i data-lucide="search" class="w-5 h-5"></i>
                        Search
                    </button>
                </div>

                <!-- Quick Examples -->
                <div class="text-center">
                    <p class="text-gray-500 mb-3">Quick examples:</p>
                    <div class="flex flex-wrap gap-2 justify-center">
                        <button onclick="loadCompanyExample('microsoft.com')" 
                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors text-sm">
                            microsoft.com
                        </button>
                        <button onclick="loadCompanyExample('salesforce.com')" 
                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors text-sm">
                            salesforce.com
                        </button>
                        <button onclick="loadCompanyExample('hubspot.com')" 
                                class="px-4 py-2 bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors text-sm">
                            hubspot.com
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6 fade-in">
            <div class="flex items-center gap-3">
                <i data-lucide="alert-circle" class="w-5 h-5 text-red-500"></i>
                <span class="text-red-700 font-medium" id="error-text"></span>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loading-grid" class="hidden">
            <div class="bg-white rounded-xl shadow-lg p-8 mb-8 fade-in">
                <div class="text-center">
                    <div class="inline-flex items-center gap-3 mb-4">
                        <div class="w-8 h-8 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
                        <h3 class="text-xl font-semibold text-gray-800">Searching Multiple Databases</h3>
                    </div>
                    <div id="fusion-progress" class="space-y-4">
                        <div id="fusion-status" class="text-gray-600"></div>
                        <div class="flex justify-center space-x-8">
                            <div class="text-center">
                                <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mb-2">
                                    <i data-lucide="database" class="w-8 h-8 text-yellow-600"></i>
                                </div>
                                <div class="text-sm font-medium text-gray-700">Database 1</div>
                                <div class="text-xs text-gray-500">Hunter.io</div>
                            </div>
                            <div class="text-center">
                                <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mb-2">
                                    <i data-lucide="database" class="w-8 h-8 text-blue-600"></i>
                                </div>
                                <div class="text-sm font-medium text-gray-700">Database 2</div>
                                <div class="text-xs text-gray-500">Apollo.io</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <!-- Stats Overview -->
            <div id="stats-overview" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow p-6 text-center">
                    <div class="text-3xl font-bold text-blue-600" id="total-contacts">0</div>
                    <div class="text-gray-600">Total Contacts</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 text-center">
                    <div class="text-3xl font-bold text-green-600" id="verified-contacts">0</div>
                    <div class="text-gray-600">Verified Emails</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 text-center">
                    <div class="text-3xl font-bold text-purple-600" id="linkedin-contacts">0</div>
                    <div class="text-gray-600">LinkedIn Profiles</div>
                </div>
                <div class="bg-white rounded-lg shadow p-6 text-center">
                    <div class="text-3xl font-bold text-orange-600" id="data-sources">0</div>
                    <div class="text-gray-600">Data Sources</div>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Contact Results</h3>
                <div class="flex gap-3">
                    <button onclick="selectAllContacts()" 
                            class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors">
                        Select All
                    </button>
                    <button onclick="exportSelectedContacts()" 
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i>
                        Export Selected
                    </button>
                </div>
            </div>

            <!-- Contact Cards -->
            <div id="contacts-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Contact cards will be dynamically inserted here -->
            </div>
        </div>
    </main>

    <script>
        // API Configuration
        const HUNTER_API_KEY = '64514bd46213dce4c8e6ed724555b2f9d0fa8e03';
        const APOLLO_API_KEY = 'cgAc0fBksS1tJePYf0n4DA';
        
        let currentContacts = [];
        let selectedContacts = new Set();
        let companyData = null;
        let fusionStats = { sources: 0, verified: 0, linkedin: 0 };

        // Initialize Lucide icons
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        });

        // Allow Enter key to trigger search
        document.getElementById('domain-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchCompany();
            }
        });

        // Utility Functions
        function hideError() {
            document.getElementById('error-message').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').classList.remove('hidden');
        }

        function hideResults() {
            document.getElementById('results-section').classList.add('hidden');
        }

        function showLoading() {
            document.getElementById('loading-grid').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading-grid').classList.add('hidden');
        }

        function showFusionProgress() {
            updateFusionStatus('Initializing multi-source data fusion...');
        }

        function updateFusionStatus(message) {
            const statusElement = document.getElementById('fusion-status');
            if (statusElement) {
                statusElement.innerHTML = message;
            }
        }

        function loadCompanyExample(domain) {
            document.getElementById('domain-input').value = domain;
            searchCompany();
        }

        // Apollo API Function
        async function searchApollo(domain, limit) {
            const requestBody = {
                api_key: APOLLO_API_KEY,
                q_organization_domains: domain,
                page: 1,
                per_page: Math.min(limit, 100),
                q_person_seniorities: ['manager', 'director', 'vp', 'c_level'],
                sort_by_field: 'person_seniority',
                sort_ascending: false,
                email_status: ['verified'],
                q_person_emails: true,
                include_emails: true
            };

            try {
                const response = await fetch('/.netlify/functions/apollo-proxy', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Apollo API error: ${response.status} - ${errorData.error || 'Unknown error'}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Apollo API call failed:', error.message);
                throw error;
            }
        }

        // Hunter API Function
        async function searchHunter(domain, limit) {
            try {
                const response = await fetch(`https://api.hunter.io/v2/domain-search?domain=${domain}&limit=${limit}&api_key=${HUNTER_API_KEY}`);
                
                if (!response.ok) {
                    throw new Error(`Hunter API error: ${response.status}`);
                }
                
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Hunter API call failed:', error.message);
                throw error;
            }
        }

        // Data Fusion Function
        function fuseDataSources(hunterResults, apolloResults, domain) {
            let fusedContacts = [];
            
            // Process Apollo results (people array)
            if (apolloResults && apolloResults.people) {
                apolloResults.people.forEach(person => {
                    const email = person.email === "email_not_unlocked@domain.com" 
                        ? `${person.first_name?.toLowerCase()}.${person.last_name?.toLowerCase()}@${domain}` 
                        : person.email;
                        
                    fusedContacts.push({
                        name: person.name || `${person.first_name} ${person.last_name}`,
                        firstName: person.first_name,
                        lastName: person.last_name,
                        title: person.title,
                        email: email,
                        phone: person.phone_numbers?.[0]?.raw_number,
                        linkedin: person.linkedin_url,
                        company: person.organization?.name || domain,
                        source: 'Apollo',
                        location: `${person.city || ''}, ${person.state || ''}, ${person.country || ''}`.replace(/^,\s*|,\s*$/g, ''),
                        department: person.departments?.[0] || '',
                        seniority: person.seniority || '',
                        verified: person.email_status === 'verified' ? 'Yes' : 'No',
                        confidence: person.email_status === 'verified' ? 'High' : 'Medium'
                    });
                });
            }
            
            // Process Hunter results (emails array)
            if (hunterResults && hunterResults.data && hunterResults.data.emails) {
                hunterResults.data.emails.forEach(email => {
                    fusedContacts.push({
                        name: `${email.first_name} ${email.last_name}`,
                        firstName: email.first_name,
                        lastName: email.last_name,
                        title: email.position,
                        email: email.value,
                        phone: email.phone_number,
                        linkedin: email.linkedin,
                        company: hunterResults.data.domain || domain,
                        source: 'Hunter',
                        location: '',
                        department: email.department || '',
                        seniority: email.seniority || '',
                        verified: email.confidence > 80 ? 'Yes' : 'No',
                        confidence: email.confidence > 80 ? 'High' : 'Medium'
                    });
                });
            }
            
            return fusedContacts;
        }

        // Main Search Function
        async function searchCompany() {
            const domainInput = document.getElementById('domain-input');
            const domain = domainInput.value.trim().toLowerCase();
            
            if (!domain) {
                showError('Please enter a company domain');
                return;
            }
            
            // Clean domain (remove protocol, www, etc.)
            const cleanDomain = domain.replace(/^(https?:\/\/)?(www\.)?/, '').split('/')[0];
            
            hideError();
            hideResults();
            showLoading();
            showFusionProgress();
            
            try {
                updateFusionStatus('ðŸ” Searching Database 1 (Hunter.io)...');
                
                let hunterData = null;
                let apolloData = null;
                let errors = [];
                
                // Search Hunter.io
                try {
                    hunterData = await searchHunter(cleanDomain, 25);
                    updateFusionStatus('âœ… Database 1 complete. Searching Database 2 (Apollo.io)...');
                } catch (error) {
                    errors.push(`Hunter API: ${error.message}`);
                    updateFusionStatus('âš ï¸ Database 1 limited. Searching Database 2 (Apollo.io)...');
                }
                
                // Search Apollo.io
                try {
                    apolloData = await searchApollo(cleanDomain, 25);
                    updateFusionStatus('âœ… Database 2 complete. Fusing data sources...');
                } catch (error) {
                    errors.push(`Apollo API: ${error.message}`);
                    updateFusionStatus('âš ï¸ Database 2 limited. Fusing available data...');
                }
                
                // Fuse data from both sources
                const contacts = fuseDataSources(hunterData, apolloData, cleanDomain);
                
                if (contacts.length === 0) {
                    throw new Error('No contacts found across any data sources for this domain.');
                }
                
                updateFusionStatus('ðŸŽ¯ Data fusion complete! Optimizing results...');
                
                // Process and display results
                currentContacts = contacts;
                selectedContacts.clear();
                
                // Calculate stats
                fusionStats = {
                    sources: (hunterData ? 1 : 0) + (apolloData ? 1 : 0),
                    verified: contacts.filter(c => c.verified === 'Yes').length,
                    linkedin: contacts.filter(c => c.linkedin).length
                };
                
                displayResults(contacts);
                
                if (errors.length > 0) {
                    console.warn('Some API errors occurred:', errors);
                }
                
            } catch (error) {
                console.error('Search failed:', error);
                showError(error.message);
            } finally {
                hideLoading();
            }
        }

        // Display Results Function
        function displayResults(contacts) {
            // Update stats
            document.getElementById('total-contacts').textContent = contacts.length;
            document.getElementById('verified-contacts').textContent = fusionStats.verified;
            document.getElementById('linkedin-contacts').textContent = fusionStats.linkedin;
            document.getElementById('data-sources').textContent = fusionStats.sources;
            
            // Display contact cards
            const contactsGrid = document.getElementById('contacts-grid');
            contactsGrid.innerHTML = '';
            
            contacts.forEach((contact, index) => {
                const card = createContactCard(contact, index);
                contactsGrid.appendChild(card);
            });
            
            document.getElementById('results-section').classList.remove('hidden');
            
            // Re-initialize Lucide icons for new content
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        // Create Contact Card Function
        function createContactCard(contact, index) {
            const card = document.createElement('div');
            card.className = 'contact-card rounded-lg p-6 card-hover';
            
            const sourceClass = contact.source === 'Hunter' ? 'hunter-badge' : 'apollo-badge';
            const verifiedIcon = contact.verified === 'Yes' ? 'check-circle' : 'alert-circle';
            const verifiedColor = contact.verified === 'Yes' ? 'text-green-500' : 'text-yellow-500';
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-4">
                    <div class="flex-1">
                        <h3 class="font-semibold text-lg text-gray-800 mb-1">${contact.name}</h3>
                        <p class="text-gray-600 text-sm">${contact.title}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="source-badge ${sourceClass}">${contact.source}</span>
                        <label class="inline-flex items-center">
                            <input type="checkbox" 
                                   class="form-checkbox h-4 w-4 text-blue-600 rounded" 
                                   onchange="toggleContactSelection(${index}, this.checked)">
                        </label>
                    </div>
                </div>
                
                <div class="space-y-3">
                    <div class="flex items-center gap-3">
                        <i data-lucide="mail" class="w-4 h-4 text-gray-400"></i>
                        <a href="mailto:${contact.email}" 
                           class="text-blue-600 hover:text-blue-800 text-sm break-all">
                            ${contact.email}
                        </a>
                        <i data-lucide="${verifiedIcon}" class="w-4 h-4 ${verifiedColor}"></i>
                    </div>
                    
                    ${contact.phone ? `
                        <div class="flex items-center gap-3">
                            <i data-lucide="phone" class="w-4 h-4 text-gray-400"></i>
                            <span class="text-gray-700 text-sm">${contact.phone}</span>
                        </div>
                    ` : ''}
                    
                    <div class="flex items-center gap-3">
                        <i data-lucide="building" class="w-4 h-4 text-gray-400"></i>
                        <span class="text-gray-700 text-sm">${contact.company}</span>
                    </div>
                    
                    ${contact.location ? `
                        <div class="flex items-center gap-3">
                            <i data-lucide="map-pin" class="w-4 h-4 text-gray-400"></i>
                            <span class="text-gray-700 text-sm">${contact.location}</span>
                        </div>
                    ` : ''}
                    
                    ${contact.linkedin ? `
                        <div class="flex items-center gap-3">
                            <i data-lucide="linkedin" class="w-4 h-4 text-gray-400"></i>
                            <a href="${contact.linkedin}" 
                               target="_blank" 
                               class="text-blue-600 hover:text-blue-800 text-sm">
                                LinkedIn Profile
                            </a>
                        </div>
                    ` : ''}
                </div>
            `;
            
            return card;
        }

        // Contact Selection Functions
        function toggleContactSelection(index, selected) {
            if (selected) {
                selectedContacts.add(index);
            } else {
                selectedContacts.delete(index);
            }
        }

        function selectAllContacts() {
            const checkboxes = document.querySelectorAll('#contacts-grid input[type="checkbox"]');
            const allSelected = selectedContacts.size === currentContacts.length;
            
            checkboxes.forEach((checkbox, index) => {
                checkbox.checked = !allSelected;
                if (!allSelected) {
                    selectedContacts.add(index);
                } else {
                    selectedContacts.delete(index);
                }
            });
        }

        // Export Function
        function exportSelectedContacts() {
            if (selectedContacts.size === 0) {
                showError('Please select at least one contact to export');
                return;
            }
            
            const selectedData = Array.from(selectedContacts).map(index => currentContacts[index]);
            const csvContent = convertToCSV(selectedData);
            downloadCSV(csvContent, 'contacts-export.csv');
        }

        function convertToCSV(contacts) {
            const headers = ['Name', 'Email', 'Title', 'Company', 'Phone', 'LinkedIn', 'Source', 'Verified'];
            const rows = contacts.map(contact => [
                contact.name,
                contact.email,
                contact.title,
                contact.company,
                contact.phone || '',
                contact.linkedin || '',
                contact.source,
                contact.verified
            ]);
            
            return [headers, ...rows]
                .map(row => row.map(field => `"${(field || '').replace(/"/g, '""')}"`).join(','))
                .join('\n');
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }
    </script>
</body>
</html>
