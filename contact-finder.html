<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Simplified - Contact Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .contact-card {
            transition: all 0.2s ease;
        }
        .contact-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .table-row:hover {
            background-color: #f8fafc;
        }
        .checkbox-custom {
            appearance: none;
            width: 18px;
            height: 18px;
            border: 2px solid #d1d5db;
            border-radius: 3px;
            background-color: white;
            position: relative;
            cursor: pointer;
        }
        .checkbox-custom:checked {
            background-color: #667eea;
            border-color: #667eea;
        }
        .checkbox-custom:checked::after {
            content: '✓';
            position: absolute;
            color: white;
            font-size: 12px;
            top: -2px;
            left: 2px;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <h1 class="text-xl font-bold text-gray-900">Sales Simplified</h1>
                    </div>
                    <div class="ml-10 flex items-baseline space-x-4">
                        <button id="dashboardTab" class="tab-button px-3 py-2 rounded-md text-sm font-medium text-gray-900 bg-gray-100">
                            Dashboard
                        </button>
                        <button id="contactFinderTab" class="tab-button px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700">
                            Contact Finder
                        </button>
                        <button id="contactListsTab" class="tab-button px-3 py-2 rounded-md text-sm font-medium text-gray-500 hover:text-gray-700">
                            Contact Lists
                        </button>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500">Trial: <span id="trialDays">14</span> days left</span>
                    <div class="w-8 h-8 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full"></div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Dashboard Tab -->
    <div id="dashboardSection" class="tab-content">
        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-lucide="search" class="h-8 w-8 text-gray-400"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Total Searches</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="totalSearches">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-lucide="users" class="h-8 w-8 text-gray-400"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Contacts Found</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="contactsFound">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-lucide="list" class="h-8 w-8 text-gray-400"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Saved Lists</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="savedLists">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white overflow-hidden shadow rounded-lg">
                    <div class="p-5">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <i data-lucide="mail" class="h-8 w-8 text-gray-400"></i>
                            </div>
                            <div class="ml-5 w-0 flex-1">
                                <dl>
                                    <dt class="text-sm font-medium text-gray-500 truncate">Verified Emails</dt>
                                    <dd class="text-lg font-medium text-gray-900" id="verifiedEmails">0</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quick Search -->
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Quick Domain Search</h3>
                <div class="flex gap-4">
                    <input type="text" id="quickSearchDomain" placeholder="Enter domain (e.g., salesforce.com)" 
                           class="flex-1 border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <button id="quickSearchBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        Search Contacts
                    </button>
                </div>
            </div>

            <!-- Recent Lists -->
            <div class="bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Recent Contact Lists</h3>
                <div id="recentLists" class="space-y-3">
                    <!-- Recent lists will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Finder Tab -->
    <div id="contactFinderSection" class="tab-content hidden">
        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <!-- Search Section -->
            <div class="bg-white shadow rounded-lg p-6 mb-8">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Find Contacts</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Company Domain</label>
                        <input type="text" id="companyDomain" placeholder="e.g., salesforce.com" 
                               class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Job Title Keywords</label>
                        <input type="text" id="jobTitle" placeholder="e.g., CEO, Sales Director, VP" 
                               class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    </div>
                </div>
                <div class="mt-4 flex gap-4">
                    <button id="searchBtn" class="bg-indigo-600 text-white px-6 py-2 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        <span id="searchBtnText">Search Contacts</span>
                        <div id="searchSpinner" class="loading-spinner ml-2 hidden inline-block"></div>
                    </button>
                    <button id="clearBtn" class="bg-gray-200 text-gray-700 px-6 py-2 rounded-md hover:bg-gray-300">
                        Clear
                    </button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="bg-white shadow rounded-lg p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">
                        Search Results (<span id="resultCount">0</span> contacts)
                    </h3>
                    <div class="flex items-center space-x-4">
                        <div class="flex items-center space-x-2">
                            <button id="gridViewBtn" class="p-2 rounded-md bg-indigo-100 text-indigo-600">
                                <i data-lucide="grid-3x3" class="h-4 w-4"></i>
                            </button>
                            <button id="listViewBtn" class="p-2 rounded-md text-gray-400 hover:text-gray-600">
                                <i data-lucide="list" class="h-4 w-4"></i>
                            </button>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button id="selectAllBtn" class="text-sm text-indigo-600 hover:text-indigo-800">
                                Select All
                            </button>
                            <button id="saveListBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700 disabled:opacity-50" disabled>
                                Save List
                            </button>
                            <button id="exportBtn" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 disabled:opacity-50" disabled>
                                Export
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Grid View -->
                <div id="gridView" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- Grid results will be populated here -->
                </div>

                <!-- List View -->
                <div id="listView" class="hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <input type="checkbox" id="selectAllCheckbox" class="checkbox-custom">
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Company</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">LinkedIn</th>
                                </tr>
                            </thead>
                            <tbody id="listViewBody" class="bg-white divide-y divide-gray-200">
                                <!-- List results will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Lists Tab -->
    <div id="contactListsSection" class="tab-content hidden">
        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="bg-white shadow rounded-lg p-6">
                <h2 class="text-xl font-semibold text-gray-900 mb-4">Saved Contact Lists</h2>
                <div id="savedContactLists" class="space-y-4">
                    <!-- Saved lists will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Save List Modal -->
    <div id="saveListModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Save Contact List</h3>
                <input type="text" id="listNameInput" placeholder="Enter list name" 
                       class="w-full border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 mb-4">
                <div class="flex justify-end space-x-2">
                    <button id="cancelSaveBtn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-md hover:bg-gray-300">
                        Cancel
                    </button>
                    <button id="confirmSaveBtn" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                        Save List
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Global variables
        let currentContacts = [];
        let selectedContacts = [];
        let currentView = 'grid';
        let searchCount = 0;
        let totalContactsFound = 0;
        let verifiedEmailCount = 0;

        // Data persistence functions
        function getStoredData(key, defaultValue = null) {
            try {
                const stored = localStorage.getItem(key);
                return stored ? JSON.parse(stored) : defaultValue;
            } catch (e) {
                console.error('Error reading from localStorage:', e);
                return defaultValue;
            }
        }

        function setStoredData(key, value) {
            try {
                localStorage.setItem(key, JSON.stringify(value));
            } catch (e) {
                console.error('Error writing to localStorage:', e);
            }
        }

        function updateMetrics() {
            const metrics = getStoredData('salesSimplifiedMetrics', {
                totalSearches: 0,
                contactsFound: 0,
                verifiedEmails: 0,
                savedLists: 0
            });

            document.getElementById('totalSearches').textContent = metrics.totalSearches;
            document.getElementById('contactsFound').textContent = metrics.contactsFound;
            document.getElementById('verifiedEmails').textContent = metrics.verifiedEmails;
            document.getElementById('savedLists').textContent = metrics.savedLists;
        }

        function incrementMetric(metric, count = 1) {
            const metrics = getStoredData('salesSimplifiedMetrics', {
                totalSearches: 0,
                contactsFound: 0,
                verifiedEmails: 0,
                savedLists: 0
            });
            
            metrics[metric] += count;
            setStoredData('salesSimplifiedMetrics', metrics);
            updateMetrics();
        }

        function loadRecentLists() {
            const lists = getStoredData('contactLists', []);
            const recentLists = lists.slice(0, 5);
            const container = document.getElementById('recentLists');
            
            if (recentLists.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No saved lists yet. Search for contacts to create your first list.</p>';
                return;
            }

            container.innerHTML = recentLists.map(list => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                    <div>
                        <h4 class="font-medium text-gray-900">${list.name}</h4>
                        <p class="text-sm text-gray-500">${list.contacts.length} contacts • ${new Date(list.created).toLocaleDateString()}</p>
                    </div>
                    <button onclick="exportList('${list.id}')" class="text-blue-600 hover:text-blue-800 text-sm">
                        Export
                    </button>
                </div>
            `).join('');
        }

        function loadSavedLists() {
            const lists = getStoredData('contactLists', []);
            const container = document.getElementById('savedContactLists');
            
            if (lists.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No saved lists yet. Create your first list from the Contact Finder.</p>';
                return;
            }

            container.innerHTML = lists.map(list => `
                <div class="border rounded-lg p-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="font-medium text-gray-900">${list.name}</h3>
                            <p class="text-sm text-gray-500">${list.contacts.length} contacts • Created ${new Date(list.created).toLocaleDateString()}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="exportList('${list.id}')" class="bg-blue-600 text-white px-3 py-1 rounded text-sm hover:bg-blue-700">
                                Export
                            </button>
                            <button onclick="deleteList('${list.id}')" class="bg-red-600 text-white px-3 py-1 rounded text-sm hover:bg-red-700">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Tab switching
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('text-gray-900', 'bg-gray-100');
                button.classList.add('text-gray-500');
            });
            
            // Show selected tab
            document.getElementById(tabName + 'Section').classList.remove('hidden');
            
            // Add active class to selected tab
            document.getElementById(tabName + 'Tab').classList.remove('text-gray-500');
            document.getElementById(tabName + 'Tab').classList.add('text-gray-900', 'bg-gray-100');
            
            // Load data for specific tabs
            if (tabName === 'dashboard') {
                loadRecentLists();
            } else if (tabName === 'contactLists') {
                loadSavedLists();
            }
        }

        // Contact search functionality
        async function searchContacts(domain, jobTitle = '') {
            const searchBtn = document.getElementById('searchBtn');
            const searchBtnText = document.getElementById('searchBtnText');
            const searchSpinner = document.getElementById('searchSpinner');
            
            searchBtn.disabled = true;
            searchBtnText.textContent = 'Searching...';
            searchSpinner.classList.remove('hidden');
            
            try {
                const response = await fetch('/.netlify/functions/apollo-proxy', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        api_key: 'cgAc0fBksS1tJePYf0n4DA',
                        q_organization_domains: domain,
                        q_person_titles: jobTitle,
                        page: 1,
                        per_page: 25
                    })
                });

                const data = await response.json();
                
                if (data.people && data.people.length > 0) {
                    currentContacts = data.people;
                    displayResults(currentContacts);
                    incrementMetric('totalSearches');
                    incrementMetric('contactsFound', currentContacts.length);
                    
                    // Count verified emails
                    const verifiedCount = currentContacts.filter(contact => contact.email).length;
                    incrementMetric('verifiedEmails', verifiedCount);
                } else {
                    currentContacts = [];
                    document.getElementById('resultsSection').classList.add('hidden');
                    alert('No contacts found for this domain and job title combination.');
                }
            } catch (error) {
                console.error('Search error:', error);
                alert('Error searching contacts. Please try again.');
            } finally {
                searchBtn.disabled = false;
                searchBtnText.textContent = 'Search Contacts';
                searchSpinner.classList.add('hidden');
            }
        }

        function displayResults(contacts) {
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('resultCount').textContent = contacts.length;
            
            if (currentView === 'grid') {
                displayGridView(contacts);
            } else {
                displayListView(contacts);
            }
            
            updateButtonStates();
        }

        function displayGridView(contacts) {
            const container = document.getElementById('gridView');
            container.innerHTML = contacts.map((contact, index) => `
                <div class="contact-card bg-white border rounded-lg p-4 hover:shadow-md transition-shadow">
                    <div class="flex items-start space-x-3">
                        <input type="checkbox" class="contact-checkbox checkbox-custom mt-1" data-index="${index}">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center space-x-2">
                                <h3 class="text-sm font-medium text-gray-900 truncate">
                                    ${contact.first_name} ${contact.last_name}
                                </h3>
                                ${contact.email ? '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">Verified</span>' : '<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800">No Email</span>'}
                            </div>
                            <p class="text-sm text-gray-500 truncate">${contact.title || 'No title'}</p>
                            <p class="text-sm text-gray-500 truncate">${contact.organization?.name || 'No company'}</p>
                            ${contact.email ? `<p class="text-sm text-blue-600 truncate">${contact.email}</p>` : '<p class="text-sm text-gray-400">No email found</p>'}
                            <div class="mt-2 flex space-x-2">
                                ${contact.linkedin_url ? `<a href="${contact.linkedin_url}" target="_blank" class="text-blue-600 hover:text-blue-800"><i data-lucide="linkedin" class="h-4 w-4"></i></a>` : ''}
                                ${contact.email ? `<a href="mailto:${contact.email}" class="text-green-600 hover:text-green-800"><i data-lucide="mail" class="h-4 w-4"></i></a>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            // Re-initialize Lucide icons
            lucide.createIcons();
            
            // Add event listeners for checkboxes
            document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleContactSelection);
            });
        }

        function displayListView(contacts) {
            const tbody = document.getElementById('listViewBody');
            tbody.innerHTML = contacts.map((contact, index) => `
                <tr class="table-row">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <input type="checkbox" class="contact-checkbox checkbox-custom" data-index="${index}">
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="text-sm font-medium text-gray-900">${contact.first_name} ${contact.last_name}</div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${contact.title || 'No title'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm text-gray-900">${contact.organization?.name || 'No company'}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${contact.email ? `<div class="text-sm text-blue-600">${contact.email}</div>` : '<div class="text-sm text-gray-400">No email found</div>'}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        ${contact.linkedin_url ? `<a href="${contact.linkedin_url}" target="_blank" class="text-blue-600 hover:text-blue-800"><i data-lucide="external-link" class="h-4 w-4"></i></a>` : '<span class="text-gray-400">-</span>'}
                    </td>
                </tr>
            `).join('');
            
            // Re-initialize Lucide icons
            lucide.createIcons();
            
            // Add event listeners for checkboxes
            document.querySelectorAll('.contact-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', handleContactSelection);
            });
        }

        function handleContactSelection() {
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            selectedContacts = [];
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    const index = parseInt(checkbox.dataset.index);
                    selectedContacts.push(currentContacts[index]);
                }
            });
            
            updateButtonStates();
        }

        function updateButtonStates() {
            const hasSelection = selectedContacts.length > 0;
            document.getElementById('saveListBtn').disabled = !hasSelection;
            document.getElementById('exportBtn').disabled = !hasSelection;
        }

        function switchView(view) {
            currentView = view;
            
            // Update button states
            document.getElementById('gridViewBtn').className = view === 'grid' ? 
                'p-2 rounded-md bg-indigo-100 text-indigo-600' : 
                'p-2 rounded-md text-gray-400 hover:text-gray-600';
            
            document.getElementById('listViewBtn').className = view === 'list' ? 
                'p-2 rounded-md bg-indigo-100 text-indigo-600' : 
                'p-2 rounded-md text-gray-400 hover:text-gray-600';
            
            // Show/hide views
            if (view === 'grid') {
                document.getElementById('gridView').classList.remove('hidden');
                document.getElementById('listView').classList.add('hidden');
            } else {
                document.getElementById('gridView').classList.add('hidden');
                document.getElementById('listView').classList.remove('hidden');
            }
            
            // Redisplay results in new view without losing selection
            if (currentContacts.length > 0) {
                displayResults(currentContacts);
                // Restore selections
                selectedContacts.forEach(selectedContact => {
                    const index = currentContacts.findIndex(contact => 
                        contact.id === selectedContact.id || 
                        (contact.first_name === selectedContact.first_name && contact.last_name === selectedContact.last_name)
                    );
                    if (index !== -1) {
                        const checkbox = document.querySelector(`input[data-index="${index}"]`);
                        if (checkbox) checkbox.checked = true;
                    }
                });
            }
        }

        function selectAllContacts() {
            const checkboxes = document.querySelectorAll('.contact-checkbox');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const allSelected = selectedContacts.length === currentContacts.length;
            
            if (allSelected) {
                // Deselect all
                checkboxes.forEach(checkbox => checkbox.checked = false);
                selectedContacts = [];
                selectAllBtn.textContent = 'Select All';
                document.getElementById('selectAllCheckbox').checked = false;
            } else {
                // Select all
                checkboxes.forEach(checkbox => checkbox.checked = true);
                selectedContacts = [...currentContacts];
                selectAllBtn.textContent = 'Deselect All';
                document.getElementById('selectAllCheckbox').checked = true;
            }
            
            updateButtonStates();
        }

        function saveContactList() {
            if (selectedContacts.length === 0) {
                alert('Please select contacts to save.');
                return;
            }
            
            document.getElementById('saveListModal').classList.remove('hidden');
            document.getElementById('listNameInput').focus();
        }

        function confirmSaveList() {
            const listName = document.getElementById('listNameInput').value.trim();
            if (!listName) {
                alert('Please enter a list name.');
                return;
            }
            
            const lists = getStoredData('contactLists', []);
            const newList = {
                id: Date.now().toString(),
                name: listName,
                contacts: selectedContacts,
                created: new Date().toISOString()
            };
            
            lists.unshift(newList);
            setStoredData('contactLists', lists);
            incrementMetric('savedLists');
            
            document.getElementById('saveListModal').classList.add('hidden');
            document.getElementById('listNameInput').value = '';
            
            alert(`List "${listName}" saved successfully with ${selectedContacts.length} contacts!`);
        }

        function exportContacts(contacts = null) {
            const contactsToExport = contacts || selectedContacts;
            
            if (contactsToExport.length === 0) {
                alert('No contacts to export.');
                return;
            }
            
            const worksheet = XLSX.utils.json_to_sheet(contactsToExport.map(contact => ({
                'First Name': contact.first_name || '',
                'Last Name': contact.last_name || '',
                'Full Name': `${contact.first_name || ''} ${contact.last_name || ''}`.trim(),
                'Title': contact.title || '',
                'Company': contact.organization?.name || '',
                'Email': contact.email || '',
                'LinkedIn': contact.linkedin_url || '',
                'Phone': contact.phone || '',
                'Location': contact.city || contact.state || '',
                'Industry': contact.organization?.industry || ''
            })));
            
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, 'Contacts');
            
            const fileName = `contacts_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(workbook, fileName);
        }

        function exportList(listId) {
            const lists = getStoredData('contactLists', []);
            const list = lists.find(l => l.id === listId);
            
            if (list) {
                exportContacts(list.contacts);
            }
        }

        function deleteList(listId) {
            if (confirm('Are you sure you want to delete this list?')) {
                const lists = getStoredData('contactLists', []);
                const updatedLists = lists.filter(l => l.id !== listId);
                setStoredData('contactLists', updatedLists);
                
                // Update metrics
                const metrics = getStoredData('salesSimplifiedMetrics', {
                    totalSearches: 0,
                    contactsFound: 0,
                    verifiedEmails: 0,
                    savedLists: 0
                });
                metrics.savedLists = updatedLists.length;
                setStoredData('salesSimplifiedMetrics', metrics);
                
                loadSavedLists();
                updateMetrics();
            }
        }

        function clearSearch() {
            document.getElementById('companyDomain').value = '';
            document.getElementById('jobTitle').value = '';
            document.getElementById('resultsSection').classList.add('hidden');
            currentContacts = [];
            selectedContacts = [];
        }

        function quickSearch() {
            const domain = document.getElementById('quickSearchDomain').value.trim();
            if (!domain) {
                alert('Please enter a domain to search.');
                return;
            }
            
            // Switch to contact finder tab and perform search
            switchTab('contactFinder');
            document.getElementById('companyDomain').value = domain;
            searchContacts(domain);
        }

        // Event listeners
        document.getElementById('dashboardTab').addEventListener('click', () => switchTab('dashboard'));
        document.getElementById('contactFinderTab').addEventListener('click', () => switchTab('contactFinder'));
        document.getElementById('contactListsTab').addEventListener('click', () => switchTab('contactLists'));

        document.getElementById('searchBtn').addEventListener('click', () => {
            const domain = document.getElementById('companyDomain').value.trim();
            const jobTitle = document.getElementById('jobTitle').value.trim();
            
            if (!domain) {
                alert('Please enter a company domain.');
                return;
            }
            
            searchContacts(domain, jobTitle);
        });

        document.getElementById('clearBtn').addEventListener('click', clearSearch);
        document.getElementById('quickSearchBtn').addEventListener('click', quickSearch);

        // Enter key support for quick search
        document.getElementById('quickSearchDomain').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                quickSearch();
            }
        });

        // Enter key support for main search
        document.getElementById('companyDomain').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        document.getElementById('jobTitle').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('searchBtn').click();
            }
        });

        // View switching
        document.getElementById('gridViewBtn').addEventListener('click', () => switchView('grid'));
        document.getElementById('listViewBtn').addEventListener('click', () => switchView('list'));

        // Selection controls
        document.getElementById('selectAllBtn').addEventListener('click', selectAllContacts);
        document.getElementById('selectAllCheckbox').addEventListener('change', selectAllContacts);

        // List management
        document.getElementById('saveListBtn').addEventListener('click', saveContactList);
        document.getElementById('exportBtn').addEventListener('click', () => exportContacts());

        // Modal controls
        document.getElementById('cancelSaveBtn').addEventListener('click', () => {
            document.getElementById('saveListModal').classList.add('hidden');
            document.getElementById('listNameInput').value = '';
        });

        document.getElementById('confirmSaveBtn').addEventListener('click', confirmSaveList);

        // Enter key support for save list modal
        document.getElementById('listNameInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                confirmSaveList();
            }
        });

        // Auto-search functionality for dashboard quick search
        document.addEventListener('DOMContentLoaded', function() {
            // Check if there's a pending search from dashboard
            const pendingSearch = getStoredData('pendingSearch');
            if (pendingSearch) {
                // Clear the pending search
                localStorage.removeItem('pendingSearch');
                
                // Populate the search field and trigger search
                document.getElementById('companyDomain').value = pendingSearch.domain;
                if (pendingSearch.jobTitle) {
                    document.getElementById('jobTitle').value = pendingSearch.jobTitle;
                }
                
                // Trigger the search
                searchContacts(pendingSearch.domain, pendingSearch.jobTitle || '');
            }
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', function() {
            // Load initial data
            updateMetrics();
            loadRecentLists();
            
            // Check for auto-search from dashboard
            const urlParams = new URLSearchParams(window.location.search);
            const autoSearchDomain = urlParams.get('domain');
            
            if (autoSearchDomain) {
                switchTab('contactFinder');
                document.getElementById('companyDomain').value = autoSearchDomain;
                searchContacts(autoSearchDomain);
                
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        });

        // Update quick search to store pending search
        function quickSearchWithTransition() {
            const domain = document.getElementById('quickSearchDomain').value.trim();
            if (!domain) {
                alert('Please enter a domain to search.');
                return;
            }
            
            // Store the search for the contact finder tab
            setStoredData('pendingSearch', { domain: domain });
            
            // Switch to contact finder tab
            switchTab('contactFinder');
            
            // The search will be triggered by the DOMContentLoaded event listener
        }

        // Update the quick search button event listener
        document.getElementById('quickSearchBtn').removeEventListener('click', quickSearch);
        document.getElementById('quickSearchBtn').addEventListener('click', quickSearchWithTransition);

        // Update enter key support for quick search
        document.getElementById('quickSearchDomain').removeEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                quickSearch();
            }
        });
        
        document.getElementById('quickSearchDomain').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                quickSearchWithTransition();
            }
        });
    </script>
</body>
</html>
